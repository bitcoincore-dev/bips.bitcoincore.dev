<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="description" content="share and save bitcoin BIPs">
    <meta name="keywords" content="bitcoin, bitcoin improvement proposals, bip, bips, static, share">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="stylesheet" href="/style.css" />

    <title>bips.dev - BIP 389</title>
</head>

<body>
    <section class="section">
        <div class="container">
            
    <div class="level">
        <div class="level-left">
            <div class="level-item">
                <a href="/"><img src="/bips-dev-header.png" width="375", height="100" /></a>
            </div>
        </div>
        <div class="level-right">
            <div class="level-item">
                <a href="/">Back to BIPs</a>
            </div>
        </div>
    </div>

    <p class="is-size-3 has-text-weight-bold mb-0">
      BIP 389: Multipath Descriptor Key Expressions
    </p>
    <div class="level is-mobile">
        <div class="level-left">
            <div class="level-item">
                <p class="subtitle"><strong>2022-07-26</strong></p>
            </div>
        </div>
        <div class="level-right">
            <div class="level-item">
                <a href="https:&#x2F;&#x2F;github.com&#x2F;bitcoin&#x2F;bips&#x2F;blob&#x2F;master&#x2F;bip-0389.mediawiki">View on GitHub</a>
            </div>
        </div>
    </div>

    <div class="content">
      <pre style="background-color:#fafafa;color:#61676c;"><code><span>  BIP: 389
</span><span>  Layer: Applications
</span><span>  Title: Multipath Descriptor Key Expressions
</span><span>  Author: Andrew Chow &lt;andrew@achow101.com&gt;
</span><span>  Comments-Summary: No comments yet.
</span><span>  Comments-URI: https://github.com/bitcoin/bips/wiki/Comments:BIP-0389
</span><span>  Status: Draft
</span><span>  Type: Informational
</span><span>  Created: 2022-07-26
</span><span>  License: BSD-2-Clause
</span></code></pre>
<h2 id="Abstract">Abstract</h2>
<p>This document specifies a modification to Key Expressions of Descriptors
that are described in BIP 380. This modification allows Key Expressions
to indicate BIP 32 derivation path steps that can have multiple values.</p>
<h2 id="Copyright">Copyright</h2>
<p>This BIP is licensed under the BSD 2-clause license.</p>
<h2 id="Motivation">Motivation</h2>
<p>Descriptors can describe the scripts that are used in a wallet, but
wallets often require at least two descriptors for all of the scripts
that they watch for. Wallets typically have one descriptor for producing
receiving addresses, and the other for change addresses. These
descriptors are often extremely similar - they produce the same types of
scripts, derive keys from the same master key, and use derivation paths
that are almost identical. The only differences are in the derivation
path where one of the steps will be different between the descriptors.
Thus it is useful to have a notation to represent both descriptors as a
single descriptor where one of the derivation steps is a pair of values.</p>
<h2 id="Specification">Specification</h2>
<p>For extended keys and their derivations paths in a Key Expression, BIP
380 states:</p>
<ul>
<li><code>xpub</code> encoded extended public key or <code>xprv</code> encoded extended private
key (as defined in BIP 32)
<ul>
<li>Followed by zero or more <code>/NUM</code> or <code>/NUMh</code> path elements indicating
BIP 32 derivation steps to be taken after the given extended key.</li>
<li>Optionally followed by a single <code>/*</code> or <code>/*h</code> final step to denote
all direct unhardened or hardened children.</li>
</ul>
</li>
</ul>
<p>This is modifed to state:</p>
<ul>
<li><code>xpub</code> encoded extended public key or <code>xprv</code> encoded extended private
key (as defined in BIP 32)
<ul>
<li>Followed by zero or more <code>/NUM</code> (may be followed by <code>h</code>, <code>H</code>, or <code>'</code>
to indicate a hardened step) path elements indicating BIP 32
derivation steps to be taken after the given extended key.</li>
<li>Followed by zero or one <code>/&lt;NUM;NUM</code> (each <code>NUM</code> may be followed by
<code>h</code>, <code>H</code>, or <code>'</code> to indicate a hardened step) path element
indicating a tuple of BIP 32 derivation steps to be taken after the
given extended key.
<ul>
<li>Followed by zero or more <code>;NUM</code> (may be followed by <code>h</code>, <code>H</code>, or
<code>'</code> to indicate a hardened step) additional tuple values of BIP 32
derivation steps</li>
<li>Followed by a single <code>&gt;/</code></li>
</ul>
</li>
<li>Followed by zero or more <code>/NUM</code> (may be followed by <code>h</code>, <code>H</code>, or <code>'</code>
to indicate a hardened step) path elements indicating BIP 32
derivation steps to be taken after the given extended key.</li>
<li>Optionally followed by a single <code>/*</code> (may be followed by <code>h</code>, <code>H</code>,
or <code>'</code> to indicate a hardened step) final step to denote all direct
unhardened or hardened children.</li>
</ul>
</li>
</ul>
<p>When a <code>/&lt;NUM;NUM;...;NUM&gt;</code> is encountered, parsers should account for a
presence of multiple descriptors where the first descriptor uses the
first <code>NUM</code>, and a second descriptor uses the second <code>NUM</code>, and so on,
until each <code>NUM</code> is accounted for in the production of public keys,
scripts, and addresses, as well as descriptor import and export
operations. Descriptors that contain multiple Key Expressions that each
have a <code>/&lt;NUM;NUM;...;NUM&gt;</code> must have tuples of exactly the same length
so that they are derived in lockstep in the same way that <code>/*</code> paths in
multiple Key expressions are handled.</p>
<p>The common use case for this is to represent descriptors for producing
receiving and change addresses. When interpreting for this use case,
wallets should use the first descriptor for producing receiving
addresses, and the second descriptor for producing change addresses. For
this use case, the element will commonly be the value <code>/&lt;0;1&gt;</code></p>
<p>Note that only one <code>/&lt;NUM;NUM;...;NUM&gt;</code> specifier is allowed in a Key
Expression.</p>
<h2 id="Test_Vectors">Test Vectors</h2>
<p>Valid multipath descriptors followed by the descriptors they expand into
as sub-bullets</p>
<ul>
<li><code>pk(xpub68NZiKmJWnxxS6aaHmn81bvJeTESw724CRDs6HbuccFQN9Ku14VQrADWgqbhhTHBaohPX4CjNLf9fq9MYo6oDaPPLPxSb7gwQN3ih19Zm4Y/&lt;0;1&gt;)</code>
<ul>
<li><code>pk(xpub68NZiKmJWnxxS6aaHmn81bvJeTESw724CRDs6HbuccFQN9Ku14VQrADWgqbhhTHBaohPX4CjNLf9fq9MYo6oDaPPLPxSb7gwQN3ih19Zm4Y/0)</code></li>
<li><code>pk(xpub68NZiKmJWnxxS6aaHmn81bvJeTESw724CRDs6HbuccFQN9Ku14VQrADWgqbhhTHBaohPX4CjNLf9fq9MYo6oDaPPLPxSb7gwQN3ih19Zm4Y/1)</code></li>
</ul>
</li>
<li><code>pkh(xprv9s21ZrQH143K31xYSDQpPDxsXRTUcvj2iNHm5NUtrGiGG5e2DtALGdso3pGz6ssrdK4PFmM8NSpSBHNqPqm55Qn3LqFtT2emdEXVYsCzC2U/&lt;2147483647h;0&gt;/0)</code>
<ul>
<li><code>pkh(xprv9s21ZrQH143K31xYSDQpPDxsXRTUcvj2iNHm5NUtrGiGG5e2DtALGdso3pGz6ssrdK4PFmM8NSpSBHNqPqm55Qn3LqFtT2emdEXVYsCzC2U/2147483647h/0)</code></li>
<li><code>pkh(xprv9s21ZrQH143K31xYSDQpPDxsXRTUcvj2iNHm5NUtrGiGG5e2DtALGdso3pGz6ssrdK4PFmM8NSpSBHNqPqm55Qn3LqFtT2emdEXVYsCzC2U/0/0)</code></li>
</ul>
</li>
<li><code>wpkh([ffffffff/13h]xpub69H7F5d8KSRgmmdJg2KhpAK8SR3DjMwAdkxj3ZuxV27CprR9LgpeyGmXUbC6wb7ERfvrnKZjXoUmmDznezpbZb7ap6r1D3tgFxHmwMkQTPH/&lt;1;3&gt;/2/*</code>
<ul>
<li><code>wpkh([ffffffff/13h]xpub69H7F5d8KSRgmmdJg2KhpAK8SR3DjMwAdkxj3ZuxV27CprR9LgpeyGmXUbC6wb7ERfvrnKZjXoUmmDznezpbZb7ap6r1D3tgFxHmwMkQTPH/1/2/*)</code></li>
<li><code>wpkh([ffffffff/13h]xpub69H7F5d8KSRgmmdJg2KhpAK8SR3DjMwAdkxj3ZuxV27CprR9LgpeyGmXUbC6wb7ERfvrnKZjXoUmmDznezpbZb7ap6r1D3tgFxHmwMkQTPH/3/2/*)</code></li>
</ul>
</li>
<li><code>multi(2,xpub6ERApfZwUNrhLCkDtcHTcxd75RbzS1ed54G1LkBUHQVHQKqhMkhgbmJbZRkrgZw4koxb5JaHWkY4ALHY2grBGRjaDMzQLcgJvLJuZZvRcEL/&lt;1;2&gt;/*,xpub68NZiKmJWnxxS6aaHmn81bvJeTESw724CRDs6HbuccFQN9Ku14VQrADWgqbhhTHBaohPX4CjNLf9fq9MYo6oDaPPLPxSb7gwQN3ih19Zm4Y/&lt;3;4&gt;/0/*)</code>
<ul>
<li><code>multi(2,xpub6ERApfZwUNrhLCkDtcHTcxd75RbzS1ed54G1LkBUHQVHQKqhMkhgbmJbZRkrgZw4koxb5JaHWkY4ALHY2grBGRjaDMzQLcgJvLJuZZvRcEL/1/*,xpub68NZiKmJWnxxS6aaHmn81bvJeTESw724CRDs6HbuccFQN9Ku14VQrADWgqbhhTHBaohPX4CjNLf9fq9MYo6oDaPPLPxSb7gwQN3ih19Zm4Y/3/0/*)</code></li>
<li><code>multi(2,xpub6ERApfZwUNrhLCkDtcHTcxd75RbzS1ed54G1LkBUHQVHQKqhMkhgbmJbZRkrgZw4koxb5JaHWkY4ALHY2grBGRjaDMzQLcgJvLJuZZvRcEL/2/*,xpub68NZiKmJWnxxS6aaHmn81bvJeTESw724CRDs6HbuccFQN9Ku14VQrADWgqbhhTHBaohPX4CjNLf9fq9MYo6oDaPPLPxSb7gwQN3ih19Zm4Y/4/0/*)</code></li>
</ul>
</li>
<li><code>pkh(xpub661MyMwAqRbcFW31YEwpkMuc5THy2PSt5bDMsktWQcFF8syAmRUapSCGu8ED9W6oDMSgv6Zz8idoc4a6mr8BDzTJY47LJhkJ8UB7WEGuduB/&lt;0;1;2&gt;)</code>
<ul>
<li><code>pkh(xpub661MyMwAqRbcFW31YEwpkMuc5THy2PSt5bDMsktWQcFF8syAmRUapSCGu8ED9W6oDMSgv6Zz8idoc4a6mr8BDzTJY47LJhkJ8UB7WEGuduB/0)</code></li>
<li><code>pkh(xpub661MyMwAqRbcFW31YEwpkMuc5THy2PSt5bDMsktWQcFF8syAmRUapSCGu8ED9W6oDMSgv6Zz8idoc4a6mr8BDzTJY47LJhkJ8UB7WEGuduB/1)</code></li>
<li><code>pkh(xpub661MyMwAqRbcFW31YEwpkMuc5THy2PSt5bDMsktWQcFF8syAmRUapSCGu8ED9W6oDMSgv6Zz8idoc4a6mr8BDzTJY47LJhkJ8UB7WEGuduB/2)</code></li>
</ul>
</li>
<li><code>sh(multi(2,xpub6ERApfZwUNrhLCkDtcHTcxd75RbzS1ed54G1LkBUHQVHQKqhMkhgbmJbZRkrgZw4koxb5JaHWkY4ALHY2grBGRjaDMzQLcgJvLJuZZvRcEL/&lt;1;2;3&gt;/0/*,xpub68NZiKmJWnxxS6aaHmn81bvJeTESw724CRDs6HbuccFQN9Ku14VQrADWgqbhhTHBaohPX4CjNLf9fq9MYo6oDaPPLPxSb7gwQN3ih19Zm4Y/0/*,xpub661MyMwAqRbcGDZQUKLqmWodYLcoBQnQH33yYkkF3jjxeLvY8qr2wWGEWkiKFaaQfJCoi3HeEq3Dc5DptfbCyjD38fNhSqtKc1UHaP4ba3t/0/0/&lt;3;4;5&gt;/*))</code>
<ul>
<li><code>sh(multi(2,xpub6ERApfZwUNrhLCkDtcHTcxd75RbzS1ed54G1LkBUHQVHQKqhMkhgbmJbZRkrgZw4koxb5JaHWkY4ALHY2grBGRjaDMzQLcgJvLJuZZvRcEL/1/0/*,xpub68NZiKmJWnxxS6aaHmn81bvJeTESw724CRDs6HbuccFQN9Ku14VQrADWgqbhhTHBaohPX4CjNLf9fq9MYo6oDaPPLPxSb7gwQN3ih19Zm4Y/0/*,xpub661MyMwAqRbcGDZQUKLqmWodYLcoBQnQH33yYkkF3jjxeLvY8qr2wWGEWkiKFaaQfJCoi3HeEq3Dc5DptfbCyjD38fNhSqtKc1UHaP4ba3t/0/0/3/*))</code></li>
<li><code>sh(multi(2,xpub6ERApfZwUNrhLCkDtcHTcxd75RbzS1ed54G1LkBUHQVHQKqhMkhgbmJbZRkrgZw4koxb5JaHWkY4ALHY2grBGRjaDMzQLcgJvLJuZZvRcEL/2/0/*,xpub68NZiKmJWnxxS6aaHmn81bvJeTESw724CRDs6HbuccFQN9Ku14VQrADWgqbhhTHBaohPX4CjNLf9fq9MYo6oDaPPLPxSb7gwQN3ih19Zm4Y/0/*,xpub661MyMwAqRbcGDZQUKLqmWodYLcoBQnQH33yYkkF3jjxeLvY8qr2wWGEWkiKFaaQfJCoi3HeEq3Dc5DptfbCyjD38fNhSqtKc1UHaP4ba3t/0/0/4/*))</code></li>
<li><code>sh(multi(2,xpub6ERApfZwUNrhLCkDtcHTcxd75RbzS1ed54G1LkBUHQVHQKqhMkhgbmJbZRkrgZw4koxb5JaHWkY4ALHY2grBGRjaDMzQLcgJvLJuZZvRcEL/3/0/*,xpub68NZiKmJWnxxS6aaHmn81bvJeTESw724CRDs6HbuccFQN9Ku14VQrADWgqbhhTHBaohPX4CjNLf9fq9MYo6oDaPPLPxSb7gwQN3ih19Zm4Y/0/*,xpub661MyMwAqRbcGDZQUKLqmWodYLcoBQnQH33yYkkF3jjxeLvY8qr2wWGEWkiKFaaQfJCoi3HeEq3Dc5DptfbCyjD38fNhSqtKc1UHaP4ba3t/0/0/5/*))</code></li>
</ul>
</li>
</ul>
<p>Invalid descriptors</p>
<ul>
<li>Multiple multipath specifiers:
<code>pkh(xprv9s21ZrQH143K31xYSDQpPDxsXRTUcvj2iNHm5NUtrGiGG5e2DtALGdso3pGz6ssrdK4PFmM8NSpSBHNqPqm55Qn3LqFtT2emdEXVYsCzC2U/&lt;0;1&gt;/&lt;2;3&gt;)</code></li>
<li>Multipath specifier in origin:
<code>pkh([deadbeef/&lt;0;1&gt;]xpub661MyMwAqRbcFW31YEwpkMuc5THy2PSt5bDMsktWQcFF8syAmRUapSCGu8ED9W6oDMSgv6Zz8idoc4a6mr8BDzTJY47LJhkJ8UB7WEGuduB/0)</code></li>
<li>Multipath specifiers of mismatched lengths:
<code>tr(xpub661MyMwAqRbcF3yVrV2KyYetLMYA5mCbv4BhrKwUrFE9LZM6JRR1AEt8Jq4V4C8LwtTke6YEEdCZqgXp85YRk2j74EfJKhe3QybQ9kcUjs4/&lt;6;7;8;9&gt;/*,{pk(xpub6ERApfZwUNrhLCkDtcHTcxd75RbzS1ed54G1LkBUHQVHQKqhMkhgbmJbZRkrgZw4koxb5JaHWkY4ALHY2grBGRjaDMzQLcgJvLJuZZvRcEL/&lt;1;2;3&gt;/0/*),pk(xpub661MyMwAqRbcGDZQUKLqmWodYLcoBQnQH33yYkkF3jjxeLvY8qr2wWGEWkiKFaaQfJCoi3HeEq3Dc5DptfbCyjD38fNhSqtKc1UHaP4ba3t/0/0/&lt;3;4;5&gt;/*)})</code></li>
<li>Multipath specifiers of mismatched lengths:
<code>sh(multi(2,xprvA1RpRA33e1JQ7ifknakTFpgNXPmW2YvmhqLQYMmrj4xJXXWYpDPS3xz7iAxn8L39njGVyuoseXzU6rcxFLJ8HFsTjSyQbLYnMpCqE2VbFWc/&lt;1;2;3&gt;/0/*,xprv9uPDJpEQgRQfDcW7BkF7eTya6RPxXeJCqCJGHuCJ4GiRVLzkTXBAJMu2qaMWPrS7AANYqdq6vcBcBUdJCVVFceUvJFjaPdGZ2y9WACViL4L/0/*,xprv9s21ZrQH143K3jUwNHoqQNrtzJnJmx4Yup8NkNLdVQCymYbPbJXnPhwkfTfxZfptcs3rLAPUXS39oDLgrNKQGwbGsEmJJ8BU3RzQuvShEG4/0/0/&lt;3;4&gt;/*))</code></li>
<li>Empty multipath specifier:
<code>wpkh(xpub661MyMwAqRbcFW31YEwpkMuc5THy2PSt5bDMsktWQcFF8syAmRUapSCGu8ED9W6oDMSgv6Zz8idoc4a6mr8BDzTJY47LJhkJ8UB7WEGuduB/&lt;&gt;/*)</code></li>
<li>Missing multipath start:
<code>wpkh(xpub661MyMwAqRbcFW31YEwpkMuc5THy2PSt5bDMsktWQcFF8syAmRUapSCGu8ED9W6oDMSgv6Zz8idoc4a6mr8BDzTJY47LJhkJ8UB7WEGuduB/0&gt;/*)</code></li>
<li>Missing multipath end:
<code>wpkh(xpub661MyMwAqRbcFW31YEwpkMuc5THy2PSt5bDMsktWQcFF8syAmRUapSCGu8ED9W6oDMSgv6Zz8idoc4a6mr8BDzTJY47LJhkJ8UB7WEGuduB/&lt;0/*)</code></li>
<li>Missing index in multipath specifier:
<code>wpkh(xpub661MyMwAqRbcFW31YEwpkMuc5THy2PSt5bDMsktWQcFF8syAmRUapSCGu8ED9W6oDMSgv6Zz8idoc4a6mr8BDzTJY47LJhkJ8UB7WEGuduB/&lt;0;&gt;/*)</code></li>
</ul>
<h2 id="Backwards_Compatibility">Backwards Compatibility</h2>
<p>This is an addition to the Key Expressions defined in BIP 380. Key
Expressions using the format described in BIP 380 are compatible with
this modification and parsers that implement this will still be able to
parse such descriptors. However as this is an addition to Key
Expressions, older parsers will not be able to understand such
descriptors.</p>
<p>This modification to Key Expressions uses two new characters: <code>&lt;</code> and
<code>;</code>. These are part of the descriptor character set and so are covered
by the checksum algorithm. As these are previously unused characters,
old parsers will not accidentally mistake them for indicating something
else.</p>
<p>This proposal is in contrast to similar proposals such as BIP 88 which
allow for multiple derivation indexes in a single element. This
limitation exists in order to reduce the number of descriptors that are
expanded, avoid confusion about how to expand the descriptor, and avoid
having expanded descriptors that users are not expecting.</p>
<h2 id="Reference_Implementation">Reference Implementation</h2>
<p><a rel="noopener" target="_blank" href="https://github.com/bitcoin/bitcoin/pull/22838">https://github.com/bitcoin/bitcoin/pull/22838</a></p>

    </div>

        </div>
    </section>
    <footer class="footer">
        <div class="container has-text-centered has-text-weight-bold is-family-monospace">
            <p class="mb-1">Updated <span class="tag is-medium is-warning is-light">2023-10-04</span></p>
            <p>bips.dev - Made with &#x2615; by <a href="https://twitter.com/nickmonad">nickmonad</a></p>
            <p>Check it out on <a href="https://github.com/nickmonad/bips-dev">GitHub</a></p>
            <p>Stay humble. Stack sats. &#x20bf;</p>
        </div>
    </footer>

     
</body>
</html>
